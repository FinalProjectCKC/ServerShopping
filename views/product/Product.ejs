<% include ../partials/Header %>

<body>
	<div class="wrapper">
		<% include ../partials/RightBar %>

		<div class="main">
			<% include ../partials/SearchBar %>

			<main class="content">
				<!--Form Product-->
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">
							<!-- BEGIN AddProductType modal -->
							<button type="button" class="btn btn-success" data-toggle="modal" data-target="#addProductModal">
								Thêm sản phẩm
							</button>
							<div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-hidden="true">
								<div class="modal-dialog" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title">Thêm sản phẩm</h5>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
										</div>
										<div class="modal-body m-3">
											<form id="addProductForm" enctype="multipart/form-data">
												<div class="form-group">
													<div class="row">
														<div class="col-md-6">
															<label class="form-label col-6 col-xl-6">Tên sản phẩm</label>
															<input type="text" name="addProductName" class="form-control" required="required"
																placeholder="Tên sản phẩm">
														</div>
														<div class="col-md-6">
															<label class="form-label">Loại sản phẩm</label>
															<select id="addTypeProduct" name="addTypeProduct" class="custom-select mb-3">
																<option value="<%= listProductType[0]._id %>" selected="">
																	<%= listProductType[0].typeName %></option>
																<% for (var i = 1; i < listProductType.length; i++) { %>
																<option value="<%= listProductType[i]._id %>"><%= listProductType[i].typeName %>
																</option>
																<% } %>
															</select>
														</div>
														<div class="col-md-6">
															<label class="form-label">Trạng thái</label>
															<select name="addStatus" class="custom-select mb-3">
																<option value="1" selected="">Còn hàng</option>
																<option value="0" selected="">Hết hàng</option>
															</select>
														</div>
													</div>
												</div>
												<div class="form-group">
													<div class="row">
														<div class="col-md-4">
															<label class="form-label col-6 col-xl-6">Đơn vị</label>
															<input type="text" name="addUnit" class="form-control" required="required"
																placeholder="Đơn vị">
														</div>
														<div class="col-md-4">
															<label class="form-label">Số lượng</label>
															<input type="number" min="0" name="addQuan" required="required" class="form-control"
																placeholder="Số lượng">
														</div>
														<div class="col-md-4">
															<label class="form-label col-6 col-xl-6">Đơn giá</label>
															<input type="number" min="0" name="addPrice" required="required" class="form-control"
																placeholder="Đơn giá">
														</div>
													</div>
												</div>
												<div class="form-group">
													<label class="form-label">Mô tả</label>
													<textarea class="form-control" name="addDescription" placeholder="Mô tả sản phẩm"
														rows="3"></textarea>
												</div>
												<div class="form-group">
													<label class="form-label w-100">Ảnh sản phẩm</label>
													<input name="addInputImg" id="addInputImg" type="file" required="required"
														onchange="loadImg(event)" accept="image/png, image/jpeg">
													<small class="form-text text-muted">
														<img name="productImg" id="productImg" src="/img/product/default.png" height="200px"
															width="200px" alt="No IMG">
													</small>
												</div>
												<div class="form-group">
													<label class="custom-control custom-checkbox">
													</label>
												</div>
											</form>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-dismiss="modal">Huỷ</button>
											<button type="button" id="btnSubmit" onclick="addProduct(event)" name="btnCreate"
												class="btn btn-success">Thêm mới</button>
										</div>
									</div>
								</div>
							</div>
							<!-- END AddProductType modal -->
							<!-- BEGIN EditProductType modal -->
							<div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-hidden="true">
								<div class="modal-dialog" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title">Cập nhật loại sản phẩm</h5>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
										</div>
										<div class="modal-body m-3">
											<form id="productForm" enctype="multipart/form-data">
												<div class="form-group">
													<div class="row">
														<div class="col-md-6">
															<label class="form-label col-6 col-xl-6">Tên sản phẩm</label>
															<input type="text" name="productName" class="form-control" required="required"
																placeholder="Tên sản phẩm">
														</div>
														<div class="col-md-6">
															<label class="form-label">Loại sản phẩm</label>
															<select name="typeProduct" class="custom-select mb-3">
																<option value="<%= listProductType[0].typeName %>" selected="">
																	<%= listProductType[0].typeName %></option>
																<% for (var i = 1; i < listProductType.length; i++) { %>
																<option value="<%= listProductType[i].typeName %>"><%= listProductType[i].typeName %>
																</option>
																<% } %>
															</select>
														</div>
														<div class="col-md-6">
															<label class="form-label">Trạng thái</label>
															<select name="status" class="custom-select mb-3">
																<option value="1" selected="">Còn hàng</option>
																<option value="0" selected="">Hết hàng</option>
															</select>
														</div>
													</div>
												</div>
												<div class="form-group">
													<div class="row">
														<div class="col-md-4">
															<label class="form-label col-6 col-xl-6">Đơn vị</label>
															<input type="text" name="unit" class="form-control" required="required"
																placeholder="Đơn vị">
														</div>
														<div class="col-md-4">
															<label class="form-label">Số lượng</label>
															<input type="number" min="0" name="quan" required="required" class="form-control"
																placeholder="Số lượng">
														</div>
														<div class="col-md-4">
															<label class="form-label col-6 col-xl-6">Đơn giá</label>
															<input type="number" min="0" name="price" required="required" class="form-control"
																placeholder="Đơn giá">
														</div>
													</div>
												</div>
												<div class="form-group">
													<label class="form-label">Mô tả</label>
													<textarea class="form-control" name="description" placeholder="Mô tả sản phẩm"
														rows="3"></textarea>
												</div>
												<div class="form-group">
													<label class="form-label w-100">Ảnh sản phẩm</label>
													<input name="inputImg" id="inputImg" type="file" required="required" onchange="loadImg(event)"
														accept="image/png, image/jpeg">
													<small class="form-text text-muted">
														<img name="productImg" id="productImg" src="#" height="200px" width="200px" alt="No IMG">
													</small>
												</div>
												<div class="form-group">
													<label class="custom-control custom-checkbox">
													</label>
												</div>
												<button type="submit" name="btnCreate" class="btn btn-primary">Thêm loại sản phẩm</button>
											</form>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-dismiss="modal">Huỷ</button>
											<button type="button" id="btnSubmit" onclick="editType(event)" name="btnCreate"
												class="btn btn-success">Cập nhật</button>
										</div>
									</div>
								</div>
							</div>
							<!-- END EditProductType modal -->
							<!-- BEGIN DeleteProductType modal -->
							<div class="modal modal-colored modal-danger fade" id="DeleteProductModal" tabindex="-1" role="dialog"
								aria-hidden="true">
								<div class="modal-dialog" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title">Cảnh báo</h5>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
										</div>
										<div class="modal-body m-3">
											<p name="typeIdDel" hidden></p>
											<p class="mb-0">Bạn có muốn xoá loại sản phẩm này?</p>
											<p name="typeNameDel"></p>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-light" data-dismiss="modal">Huỷ</button>
											<button type="button" onclick="deleteType(event)" class="btn btn-light">Xoá</button>
										</div>
									</div>
								</div>
							</div>
							<!-- END DeleteProductType modal -->
						</div>
					</div>
				</div>
				<!--ListProduct-->
				<div class="col-12 col-xl-12">
					<div class="card">
						<div class="card-header">
							<h5 class="card-title">Danh sách sản phẩm</h5>
							<div style="text-align:center;">
								<input style="display: inline;" type="text" class="form-control col-6" placeholder="Search…">
								<div style="display: inline;" class="input-group-append">
									<button class="btn" type="button">
										<i class="align-middle" data-feather="search"></i>
									</button>
								</div>
								<select style="display: inline;" id="limit" class="form-control col-2">
									<option value="1">1</option>
									<option value="10">10</option>
									<option value="25">25</option>
									<option value="50">50</option>
									<option value="100">100</option>
									<option value="500">500</option>
									<option value="9999">all</option>
								</select>
							</div>
						</div>
						<table class="table">
							<thead>
								<tr>
									<th style="width:15%;">Tên sản phẩm</th>
									<th style="width:15%">Mô tả</th>
									<th style="width:15%">Hình ảnh</th>
									<th style="width:15%;">Số lượng</th>
									<th style="width:15%">Đơn vị</th>
									<th style="width:15%">Giá</th>
									<th>Tuỳ chỉnh</th>
								</tr>
							</thead>
							<tbody>
								<% for (var i = 0; i < listProduct.length; i++) { %>
								<tr>
									<td><%= listProduct[i].productName %></td>
									<td><%= listProduct[i].description %></td>
									<td>
										<img src="<%= listProduct[i].productImg %>" class="avatar img-fluid" alt="No IMG">
									</td>
									<td><%= listProduct[i].quan %></td>
									<td><%= listProduct[i].unit %></td>
									<td><%= listProduct[i].price %></td>

									<td class="table-action">
										<button type="button" name="btn_edit"><i class="align-middle" data-feather="edit-2"></i></button>
										<button type="button" name="btn_delete"><i class="align-middle" data-feather="trash"></i></button>
									</td>
								</tr>
								<% } %>

							</tbody>
						</table>
					</div>
					<!-- Page phân trang -->
					<button name="pagetype" style="background-color:dimgray;" value="0" type="button">0</button>
					<div id="countPage">
						<% for (var i = 0; i < 10; i++) { %>
						<button name="pagetype" style="background-color:dimgray;" value="<%= i %>" type="button"><%= i %></button>
						<% } %>
					</div>
				</div>
			</main>
			<% include ../partials/Footer %>
		</div>
	</div>
	<script type="text/javascript">
		var loadImg = function (event) {
			$('#productImg').attr('src', URL.createObjectURL(event.target.files[0]));
		};

		$('[name=btn_edit]').click(function () {
			var name = ($(this).parent().parent().children().eq(0).html());
			var des = ($(this).parent().parent().children().eq(1).html());
			var img = ($(this).parent().parent().children().eq(2).children().eq(0).attr("src"));
			var quan = ($(this).parent().parent().children().eq(3).html());
			var unit = ($(this).parent().parent().children().eq(4).html());
			var price = ($(this).parent().parent().children().eq(5).html());
			$('[name=producName]').val(name);
			$('[name=description]').val(des);
			$('[name=productImg]').attr('src', img);
			$('[name=btnCreate]').html('Cập nhật');
			$('#productForm').attr('action', '/productType/editType');
			$('[name=btnCreate]').attr('name', 'btnUpdate');
		});
	</script>
	<script type="text/javascript">
		var addProduct = function (event) {
			event.preventDefault();
			var formData1 = new FormData();
			var typeProduct= 	$( "#addTypeProduct option:selected" ).val();
			var productName = $('[name=addProductName]').val();
			var des = $('[name=addDescription]').val();
			// var status = $('[name=addStatus]').val();
			var unit = $('[name=addUnit]').val();
			var quan = $('[name=addQuan]').val();
			var price = $('[name=addPrice]').val();
			var file = $('[name=addInputImg]').get(0).files;

			formData1.append('addInputImg', file[0]);
			formData1.append('typeProduct', typeProduct);
			formData1.append('description', des);
			// formData1.append('status', status);
			formData1.append('productName', productName);
			formData1.append('unit', unit);
			formData1.append('quan', quan);
			formData1.append('price', price);

			console.log(formData1.append)
			$.ajax({
				url: 'product/addProduct',
				type: 'POST',
				data: formData1,
				cache: false,
				contentType: false,
				processData: false,
			}).done(function (result) {
				if (result.success) {
					alert(result.mgs)
					location.reload()
				} else {
					alert(result.mgs)
				}
			}).fail(() => {
				alert("Không kết nối được với server")
			})
		}
		var editProduct = function (event) {
			event.preventDefault();
			alert("editProduct")
			// var formData = new FormData();
			// var typeId = $('[name=editTypeId]').val();
			// var typeName = $('[name=editTypeName]').val();
			// var des = $('[name=editDescription]').val();
			// var file = $('[name=editTypeImg]').get(0).files;

			// formData.append('typeId', typeId);
			// formData.append('imgType', file[0]);
			// formData.append('typeName', typeName);
			// formData.append('description', des);

			// $.ajax({
			// 	url: 'productType/editType',
			// 	type: 'POST',
			// 	data: formData,
			// 	cache: false,
			// 	contentType: false,
			// 	processData: false,
			// }).done(function (result) {
			// 	if (result.success) {
			// 		alert(result.mgs)
			// 		location.reload()
			// 	} else {
			// 		alert(result.mgs)
			// 	}
			// }).fail(() => {
			// 	alert("Không kết nối được với server")
			// })
		}
		var deleteProduct = function (event) {
			event.preventDefault();
			alert("deleteProduct")
			// var formData = new FormData();
			// var typeId = $('[name=typeIdDel]').text();

			// formData.append('typeId', typeId);

			// $.ajax({
			// 	url: 'productType/deleteType',
			// 	type: 'POST',
			// 	data: formData,
			// 	cache: false,
			// 	contentType: false,
			// 	processData: false,
			// }).done(function (result) {
			// 	if (result.success) {
			// 		alert(result.mgs)
			// 		location.reload()
			// 	} else {
			// 		alert(result.mgs)
			// 	}
			// }).fail(() => {
			// 	alert("Không kết nối được với server")
			// })
		}
		var loadImg = function (event) {
			$('#productImg').attr('src', URL.createObjectURL(event.target.files[0]));
		};
		var loadImgEdit = function (event) {
			$('#editTypeImgForm').attr('src', URL.createObjectURL(event.target.files[0]));
		};
		//Phan trang
		$('#limit').on('change', function () {
			var optionSelected = $("option:selected", this);
			var valueSelected = this.value;
			var page = 0;
			var limit = valueSelected;
			var formData = new FormData();
			formData.append('page', page);
			formData.append('limit', limit);
			$.ajax({
				url: 'productType/getTypePage',
				type: 'POST',
				data: formData,
				cache: false,
				contentType: false,
				processData: false,
			}).done(function (result) {
				if (result.success) {
					$('#bodyTable').empty();
					$('#countPage').empty();
					for (var i = 0; i < result.countPage; i++) {
						$('#countPage').append(`<button name="pagetype" style="background-color:dimgray;" value="${i}" type="button">${i}</button>`)
					}
					for (let type of result.listProductType) {
						$('#bodyTable').append(
							`<tr>
									<td hidden> ${type._id} </td>
									<td> ${type.typeName} </td>
									<td> ${type.description}</td>
									<td>
										<img src="${type.typeImg}" class="avatar img-fluid" alt="No IMG">
									</td>
										<td class="table-action">
											<button type="button" name="btn_edit" data-toggle="modal" data-target="#editProductModal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2 align-middle"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
											<button type="button" name="btn_delete" data-toggle="modal" data-target="#DeleteProductModal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash align-middle"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
										</td>
								</tr>`
						)
					}
				} else {
					alert(result.mgs)
				}
			}).fail(() => {
				alert("Không kết nối được với server")
			})
		});
		$('[name=pagetype]').click(function () {
			var page = ($(this).val());
			var limit = $("#limit option:selected").text();
			var formData = new FormData();
			formData.append('page', page);
			formData.append('limit', limit);
			$.ajax({
				url: 'productType/getTypePage',
				type: 'POST',
				data: formData,
				cache: false,
				contentType: false,
				processData: false,
			}).done(function (result) {
				if (result.success) {
					$('#bodyTable').empty();
					// $('#countPage').empty();
					// for (var i = 0; i < result.countPage; i++) {
					// 	$('#countPage').append(	`<button  name="pageType" style="background-color:dimgray;" value="${i}" type="button">${i}</button>`)
					// }
					for (let type of result.listProductType) {
						$('#bodyTable').append(
							`<tr>
									<td hidden> ${type._id} </td>
									<td> ${type.typeName} </td>
									<td> ${type.description}</td>
									<td>
										<img src="${type.typeImg}" class="avatar img-fluid" alt="No IMG">
									</td>
										<td class="table-action">
											<button type="button" name="btn_edit" data-toggle="modal" data-target="#editProductModal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2 align-middle"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
											<button type="button" name="btn_delete" data-toggle="modal" data-target="#DeleteProductModal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash align-middle"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
										</td>
								</tr>`
						)
					}
				} else {
					alert(result.mgs)
				}
			}).fail(() => {
				alert("Không kết nối được với server")
			})
		});
		$('[name=btn_edit]').click(function () {
			var typeId = ($(this).parent().parent().children().eq(0).html());
			var name = ($(this).parent().parent().children().eq(1).html());
			var des = ($(this).parent().parent().children().eq(2).html());
			var img = ($(this).parent().parent().children().eq(3).children().eq(0).attr("src"));
			$('#editTypeImgForm').attr('src', img);
			$('[name=editTypeId]').val(typeId);
			$('[name=editTypeName]').val(name);
			$('[name=editDescription]').val(des);
		});
		$('[name=btn_delete]').click(function () {
			var typeIdDel = ($(this).parent().parent().children().eq(0).html());
			var name = ($(this).parent().parent().children().eq(1).html());
			$('[name=typeIdDel]').text(typeIdDel);
			$('[name=typeNameDel]').text(name);
		});
	</script>
	<script sr 
	<script src="js/app.js"></script>

</body>

</html>