<% include ../partials/Header %>

<body>
	<div class="wrapper">
		<% include ../partials/RightBar %>

		<div class="main">
			<% include ../partials/SearchBar %>

			<main class="content">
				<!--Form Order-->
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">
							<!-- BEGIN DeleteOrder modal -->
							<div class="modal modal-colored modal-danger fade" id="DeleteOrderModal" tabindex="-1" role="dialog"
								aria-hidden="true">
								<div class="modal-dialog" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title">Cảnh báo</h5>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
										</div>
										<div class="modal-body m-3">
											<p name="typeIdDel" hidden></p>
											<!-- <p class="mb-0">Bạn có muốn huỷ đơn hàng của: </p> -->
											<p s="mb-0" name="cusNameOrderCancel"></p>
											<label class="form-label">Vui lòng nhập lý do</label>
											<input type="text" name="reasonCancel" class="form-control" placeholder="Lý do huỷ">
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-light" data-dismiss="modal">Huỷ</button>
											<button type="button" onclick="cancelOrder(event)" class="btn btn-light">Xoá</button>
										</div>
									</div>
								</div>
							</div>
							<!-- END DeleteOrder modal -->
						</div>
					</div>
				</div>
				<!--table-->
				<div class="col-12 col-xl-12">
					<h2>Danh sách đơn hàng</h2>
					<div style="text-align:center;">
						<input style="display: inline;" type="text" class="form-control col-6" placeholder="Search…">
						<div style="display: inline;" class="input-group-append">
							<button class="btn" type="button">
								<i class="align-middle" data-feather="search"></i>
							</button>
						</div>
						<select style="display: inline;" id="status" class="form-control col-2">
							<option value="0">Đơn hàng mới</option>
							<option value="1">Đơn đã được xác nhận</option>
							<option value="2">Đơn đang giao</option>
							<option value="3">Đơn hàng đã giao</option>
							<option value="-1">Đơn hàng bị huỷ</option>
							<option value="-2">Đơn hàng bị khách huỷ</option>
						</select>
						<select style="display: inline;" id="limit" class="form-control col-2">
							<!-- <option value="1">1</option> -->
							<option value="2">2</option>
							<option value="10">10</option>
							<option value="25">25</option>
							<option value="50">50</option>
							<option value="100">100</option>
							<option value="500">500</option>
							<option value="9999">all</option>
						</select>
					</div>
					<div class="scrollmenu">
						<div class="card">
							<br />
							<table class="table" id="myTable">
								<thead>
									<tr>
										<th hidden></th>
										<th style="width:20%;">Mã hoá đơn<noscript></noscript></th>
										<th style="width:20%;">Tên khách hàng</th>
										<th style="width:20%;">Địa chỉ giao hàng</th>
										<th style="width:20%;">Số điện thoại</th>
										<th style="width:20%">Tổng tiền</th>
										<th style="width:20%">Tình trạng</th>
										<th style="width:20%">Tuỳ chỉnh</th>
									</tr>
								</thead>
								<tbody id="bodyTable">
									<% for (var i = 0; i < listOrder.length; i++) { %>
									<tr>
										<td hidden><%= listOrder[i]._id %></td>
										<td><%= listOrder[i]._id %></td>
										<td class="name" name="name"><%= listOrder[i].cusName %></td>
										<td><%= listOrder[i].address %></td>
										<td><%= listOrder[i].phone %></td>
										<td><%= listOrder[i].total %></td>
										<td><%= listOrder[i].status %></td>
										<!-- <td>
										<img src="<%= listOrder[i].typeImg %>" class="avatar img-fluid" alt="No IMG">
									</td> -->
										<td class="table-action">
											<button type="button" name="btn_edit" data-toggle="modal" data-target="#editTypeModal"><i
													class="align-middle" data-feather="edit-2"></i></button>
											<!-- <button type="button" name="btn_delete" orderCancel"> -->
											<button type="button" value="'{'id': '<%= listOrder[i]._id %>' , 'cusname':'<%= listOrder[i].cusName %>' }'" onclick="showDelete(this)" name="btn_delete">
												Huỷ đơn hàng</button>
										</td>
									</tr>
									<% } %>

								</tbody>
							</table>
						</div>
					</div>
					<!-- Page phân trang -->
					<div id="countPage">
						<% for (var i = 0; i < countPage; i++) { %>
						<button name="pagetype" onclick="phanTrang(i)" style="background-color:dimgray;" value="<%= i %>"
							type="button"><%= i %></button>
						<% } %>
					</div>
				</div>
			</main>
			<% include ../partials/Footer %>
		</div>
		<button type="button" name="btn_delete" data-toggle="modal" hidden data-target="#DeleteOrderModal">
			Huỷ đơn hàng</button>
	</div>
	<script type="text/javascript">
		var phanTrang = function (page) {
			var limit = $("#limit option:selected").text();
			var formData = new FormData();
			formData.append('page', page);
			formData.append('limit', limit);
			formData.append('status', "0");
			$.ajax({
				url: 'order/getList',
				type: 'POST',
				data: formData,
				cache: false,
				contentType: false,
				processData: false,
			}).done(function (result) {
				if (result.success) {
					$('#bodyTable').empty();
					for (let order of result.listOrder) {
						$('#bodyTable').append(
							`<tr>
									<td hidden>${order._id}</td>
									<td>${order._id}</td>
									<td>${order.cusName}</td>
									<td>${order.address}</td>
									<td>${order.phone}</td>
									<td>${order.total}</td>
									<td>${order.status}</td>
									<td class="table-action">
										<button type="button" name="btn_edit" data-toggle="modal" data-target="#editTypeModal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2 align-middle"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
										<button type="button" onclick="showDelete(event)" name="btn_delete" orderCancel">
											Huỷ đơn hàng</button>
									</td>
								</tr>`
						)
					}
				} else {
					alert(result.mgs)
				}
			}).fail(() => {
				alert("Không kết nối được với server")
			})
		}
		var editType = function (event) {
			event.preventDefault();

			var formData = new FormData();
			var typeId = $('[name=editTypeId]').val();
			var typeName = $('[name=editTypeName]').val();
			var des = $('[name=editDescription]').val();
			var file = $('[name=editTypeImg]').get(0).files;

			formData.append('typeId', typeId);
			formData.append('imgType', file[0]);
			formData.append('typeName', typeName);
			formData.append('description', des);

			$.ajax({
				url: 'Order/editType',
				type: 'POST',
				data: formData,
				cache: false,
				contentType: false,
				processData: false,
			}).done(function (result) {
				if (result.success) {
					alert(result.mgs)
					location.reload()
				} else {
					alert(result.mgs)
				}
			}).fail(() => {
				alert("Không kết nối được với server")
			})
		}
		var showDelete = function (objButton) {
			alert(objButton.value);
			let value =objButton.value // {id: "5f2253f290a3911d6acf7d30" , cusname:"asssss" }
			 value = JSON.parse('	{id: "5f2253f290a3911d6acf7d30", cusname: "asssss"}')
			var typeIdDel =value.id
			var name =value.cusName
			$('[name=cusNameOrderCancel]').text("Bạn muốn huỷ đơn hàng của: " + name);
			$('#DeleteOrderModal').modal('show');
		};
		var loadImg = function (event) {
			$('#typeImgForm').attr('src', URL.createObjectURL(event.target.files[0]));
		};
		//Phan trang
		$('#limit').on('change', function () {
			var optionSelected = $("option:selected", this);
			var valueSelected = this.value;
			var page = 0;
			var limit = valueSelected;
			var formData = new FormData();
			formData.append('page', page);
			formData.append('limit', limit);
			formData.append('status', "0");
			$.ajax({
				url: 'order/getList',
				type: 'POST',
				data: formData,
				cache: false,
				contentType: false,
				processData: false,
			}).done(function (result) {
				if (result.success) {
					$('#bodyTable').empty();
					$('#countPage').empty();
					for (var i = 0; i < result.countPage; i++) {
						$('#countPage').append(`<button type="button" style="background-color:dimgray;" name="ahihi"  value="${i}" onclick="phanTrang(${i})" >${i}</button>`)
						// $('#countPage1').append(`<button name="pagetype" style="background-color:dimgray;" value="${i}" type="button">${i}</button>`)
					}
					for (let order of result.listOrder) {
						$('#bodyTable').append(
							`
							<tr>
									<td hidden>${order._id}</td>
									<td>${order._id}</td>
									<td>${order.cusName}</td>
									<td>${order.address}</td>
									<td>${order.phone}</td>
									<td>${order.total}</td>
									<td>${order.status}</td>
									<td class="table-action">
										<button type="button" name="btn_edit" data-toggle="modal" data-target="#editTypeModal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2 align-middle"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
										<button type="button" onclick="showDelete(event)" name="btn_delete" orderCancel">
											Huỷ đơn hàng</button>
									</td>
								</tr>`
						)
					}
				} else {
					alert(result.mgs)
				}
			}).fail((error) => {
				console.log(error)
				alert("Không kết nối được với server")
			})
		});
		$('[name=pagetype]').click(function () {
			var page = ($(this).val());
			var limit = $("#limit option:selected").text();
			var formData = new FormData();
			formData.append('page', page);
			formData.append('limit', limit);
			formData.append('status', 0);
			$.ajax({
				url: 'order/getList',
				type: 'POST',
				data: formData,
				cache: false,
				contentType: false,
				processData: false,
			}).done(function (result) {
				if (result.success) {
					$('#bodyTable').empty();
					for (let order of result.listOrder) {
						$('#bodyTable').append(
							`<tr>
									<td hidden>${order._id}</td>
									<td>${order._id}</td>
									<td>${order.cusName}</td>
									<td>${order.address}</td>
									<td>${order.phone}</td>
									<td>${order.total}</td>
									<td>${order.status}</td>
									<td class="table-action">
										<button type="button" name="btn_edit" data-toggle="modal" data-target="#editTypeModal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2 align-middle"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
										<button type="button" name="btn_delete" onclick="showDelete(event)" orderCancel">
											Huỷ đơn hàng</button>
									</td>
								</tr>`
						)
					}
				} else {
					alert(result.mgs)
				}
			}).fail(() => {
				alert("Không kết nối được với server")
			})
		});

		$('[name=btn_edit]').click(function () {
			var typeId = ($(this).parent().parent().children().eq(0).html());
			var name = ($(this).parent().parent().children().eq(1).html());
			var des = ($(this).parent().parent().children().eq(2).html());
			var img = ($(this).parent().parent().children().eq(3).children().eq(0).attr("src"));
			$('#editTypeImgForm').attr('src', img);
			$('[name=editTypeId]').val(typeId);
			$('[name=editTypeName]').val(name);
			$('[name=editDescription]').val(des);
		});
		// $('[name=btn_delete]').click(function () {
		// 	// DeleteOrderModal
		// 	var typeIdDel = ($(this).parent().parent().children().eq(0).html());
		// 	var name = ($(this).parent().parent().children().eq(1).html());
		// 	var name = ($(this).parent().parent().children().eq(2).html());
		// 	$('[name=typeIdDel]').text(typeIdDel);
		// 	$('[name=cusNameOrderCancel]').text("Bạn muốn huỷ đơn hàng của: "+name);
		// 	$('#DeleteOrderModal').modal('show');
		// });
	</script>
	<style>
		div.scrollmenu {
			background-color: #fff;
			overflow: auto;
			white-space: nowrap;
		}
	</style>
	<script src="js/app.js"></script>
	<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
</body>

</html>